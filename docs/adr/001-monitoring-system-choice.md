# ADR 001: Выбор системы мониторинга

## Статус
Принято

## Контекст
Нам необходимо внедрить систему мониторинга для отслеживания состояния инфраструктуры и приложений перед релизом продукта. Требования:

- Сбор метрик с серверов (CPU, RAM, disk, network)
- Сбор метрик из приложений (custom metrics)
- Визуализация данных через дашборды
- Алертинг при проблемах
- Масштабируемость для роста инфраструктуры
- Open source решение

Рассматриваемые варианты:
1. **Prometheus + Grafana**
2. **Zabbix**
3. **Nagios**
4. **ELK Stack (Elasticsearch + Logstash + Kibana)**

## Решение
Выбрана связка **Prometheus + Grafana**

## Обоснование

### Prometheus + Grafana (✅ Выбрано)

**Преимущества:**
- ✅ De-facto стандарт для Kubernetes и cloud-native приложений
- ✅ Pull-модель сбора метрик (не требует агентов на каждом сервере)
- ✅ Нативная поддержка формата метрик в наших приложениях
- ✅ Мощный язык запросов PromQL
- ✅ Встроенная система алертинга (Alertmanager)
- ✅ Легкая интеграция с Grafana для визуализации
- ✅ Огромное сообщество и готовые экспортеры для всего
- ✅ Service Discovery (автоматическое обнаружение целей)
- ✅ Высокая производительность (time-series database)

**Недостатки:**
- ⚠️ Хранение метрик ограничено (обычно 15-30 дней, для долгосрочного хранения нужен Thanos/Cortex)
- ⚠️ Нет встроенной визуализации (нужна Grafana)

### Zabbix

**Преимущества:**
- ✅ Полнофункциональное решение "из коробки"
- ✅ Встроенная визуализация
- ✅ Хорошо подходит для мониторинга серверов

**Недостатки:**
- ❌ Устаревший UI/UX
- ❌ Сложная настройка
- ❌ Требует агентов на каждом сервере
- ❌ Менее подходит для мониторинга приложений
- ❌ Слабая интеграция с современными cloud-native решениями

### Nagios

**Преимущества:**
- ✅ Проверенное временем решение
- ✅ Большое количество плагинов

**Недостатки:**
- ❌ Устаревшая архитектура
- ❌ Плохой UI
- ❌ Сложная настройка
- ❌ Не подходит для современных микросервисов

### ELK Stack

**Преимущества:**
- ✅ Отлично подходит для логов
- ✅ Мощные возможности поиска

**Недостатки:**
- ❌ Избыточен для простого мониторинга метрик
- ❌ Высокое потребление ресурсов
- ❌ Сложность настройки
- ❌ Дорогой в эксплуатации

## Архитектура решения

```
┌─────────────────────────────────────────────────────────────┐
│                      Пользователи                           │
└────────────────┬─────────────────────────┬──────────────────┘
                 │                         │
                 │ grafana.avtostrada.kz   │ monitoring.avtostrada.kz
                 │                         │
         ┌───────▼────────┐       ┌───────▼─────────┐
         │    Grafana     │◄──────┤   Prometheus    │
         │  (Визуализация)│       │  (Сбор метрик)  │
         └────────────────┘       └─────────┬───────┘
                                            │
                   ┌────────────────────────┼────────────────────┐
                   │                        │                    │
           ┌───────▼────────┐   ┌──────────▼──────┐  ┌─────────▼──────┐
           │ Node Exporter  │   │  App Metrics    │  │  Alertmanager  │
           │  (Метрики OS)  │   │/metrics endpoint│  │   (Алерты)     │
           └────────────────┘   └─────────────────┘  └────────────────┘
```

## Компоненты

1. **Prometheus Server** - центральный сервер сбора и хранения метрик
2. **Node Exporter** - экспорт метрик операционной системы (CPU, RAM, Disk, Network)
3. **Application Metrics** - метрики из приложений через `/metrics` endpoint
4. **Grafana** - визуализация метрик через дашборды
5. **Alertmanager** - обработка и маршрутизация алертов (опционально, для будущего)

## Метрики

### Системные метрики (Node Exporter):
- CPU utilization
- Memory usage
- Disk I/O
- Network traffic
- Load average
- Disk space

### Метрики приложения:
- HTTP request rate
- Response time (latency)
- Error rate
- Active connections
- Custom business metrics

## Развертывание

- **Инфраструктура**: Terraform (отдельный сервер для мониторинга)
- **Конфигурация**: Ansible playbooks
- **Домены**: 
  - `monitoring.avtostrada.kz` → Prometheus
  - `grafana.avtostrada.kz` → Grafana

## Последствия

### Положительные:
- Получаем современную систему мониторинга
- Легко масштабируется при росте инфраструктуры
- Готовность к миграции в Kubernetes в будущем
- Большое сообщество и документация
- Множество готовых дашбордов для Grafana

### Отрицательные:
- Требуется изучение PromQL
- Для долгосрочного хранения метрик потребуется дополнительное решение
- Два компонента вместо одного (Prometheus + Grafana)

### Нейтральные:
- Необходимо добавить `/metrics` endpoint в приложения
- Требуется настройка reverse proxy для доменов

## Альтернативы в будущем

Если потребуется:
- **Долгосрочное хранение**: Thanos или Cortex
- **Мониторинг логов**: дополнить Loki (от создателей Grafana)
- **Трейсинг**: Jaeger или Tempo

## Дата
2025-11-04

## Автор
Максим Пак maxpack2030@gmail.com
